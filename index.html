<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Favicon 服务扩展测试</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; line-height: 1.6; }
        h1 { text-align: center; color: #0056b3; }
        p { text-align: center; margin-bottom: 20px; }
        .container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
        .service-section { 
            margin-bottom: 20px; 
            padding: 15px; 
            background-color: #fff; 
            border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            width: calc(50% - 20px); /* 每行显示两个服务区域 */
            min-width: 300px; /* 最小宽度 */
        }
        .service-section h2 { 
            margin-top: 0; 
            color: #0056b3; 
            border-bottom: 2px solid #0056b3; 
            padding-bottom: 10px; 
            font-size: 1.2em;
        }
        .site-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
        .site-item { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 10px; 
            border: 1px solid #eee; 
            border-radius: 4px; 
            background-color: #f9f9f9;
            text-align: center;
        }
        .site-item img { 
            width: 32px; 
            height: 32px; 
            margin-bottom: 5px; 
            border: 1px solid #ddd;
            object-fit: contain;
        }
        .site-name { font-size: 0.9em; font-weight: bold; word-break: break-all; }
        .status { font-size: 0.8em; margin-top: 5px; }
        .status.ok { color: green; }
        .status.error { color: red; }

        @media (max-width: 700px) {
            .service-section {
                width: calc(100% - 20px);
            }
        }
    </style>
</head>
<body>
    <h1>Favicon 服务可用性扩展测试</h1>
    <p>请分别在开启和关闭VPN的情况下观察以下图标的加载情况。每个服务会尝试加载20个网站的图标。</p>

    <div class="container" id="resultsContainer">
        </div>

    <script>
        const testSites = [
            // 常用国内网站
            { name: "百度", url: "https://www.baidu.com" },
            { name: "淘宝", url: "https://www.taobao.com" },
            { name: "京东", url: "https://www.jd.com" },
            { name: "腾讯", url: "https://www.qq.com" },
            { name: "新浪", url: "https://www.sina.com.cn" },
            { name: "网易", url: "https://www.163.com" },
            { name: "哔哩哔哩", url: "https://www.bilibili.com" },
            { name: "知乎", url: "https://www.zhihu.com" },
            { name: "豆瓣", url: "https://www.douban.com" },
            { name: "支付宝", url: "https://www.alipay.com" },
            // 常用国际网站
            { name: "Google", url: "https://www.google.com" },
            { name: "YouTube", url: "https://www.youtube.com" },
            { name: "Facebook", url: "https://www.facebook.com" },
            { name: "Twitter (X)", url: "https://www.twitter.com" },
            { name: "Instagram", url: "https://www.instagram.com" },
            { name: "Wikipedia", url: "https://www.wikipedia.org" },
            { name: "Amazon", url: "https://www.amazon.com" },
            { name: "Microsoft", url: "https://www.microsoft.com" },
            { name: "Apple", url: "https://www.apple.com" },
            { name: "GitHub", url: "https://github.com" }
        ];

        const faviconServices = [
            {
                name: "Google S2 Favicon (sz=32)",
                getUrl: (siteUrlFull, domain) => `https://www.google.com/s2/favicons?sz=32&domain_url=${encodeURIComponent(siteUrlFull)}`
            },
            {
                name: "DuckDuckGo Favicon (ip3)",
                getUrl: (siteUrlFull, domain) => `https://icons.duckduckgo.com/ip3/${domain}.ico`
            },
            {
                name: "Favicon Kit (32px)",
                getUrl: (siteUrlFull, domain) => `https://api.faviconkit.com/${domain}/32`
            },
            {
                name: "icon.horse (Clearbit)",
                getUrl: (siteUrlFull, domain) => `https://icon.horse/icon/${domain}` // 自动尺寸
            },
            {
                name: "Yandex Favicon (32px)",
                getUrl: (siteUrlFull, domain) => `https://favicon.yandex.net/favicon/v2/${domain}?size=32&stub=1&color=FFFFFF,00000000`
            },
            { // 新增一个备选服务
                name: "The Favicon Grabber (BestIcon)",
                getUrl: (siteUrlFull, domain) => `https://besticon-demo.herokuapp.com/icon?url=${domain}&size=32..50..120` // ? 似乎已失效或不稳定
            },
             { // 新增一个备选服务
                name: "Favicon.ico (direct root)", // 直接尝试根目录的favicon.ico
                getUrl: (siteUrlFull, domain) => {
                    try {
                        const urlObj = new URL(siteUrlFull);
                        return `${urlObj.protocol}//${urlObj.hostname}/favicon.ico`;
                    } catch {
                        return `http://${domain}/favicon.ico`; // 简易回退
                    }
                }
            }
        ];

        const resultsContainer = document.getElementById('resultsContainer');

        faviconServices.forEach(service => {
            const serviceSection = document.createElement('div');
            serviceSection.className = 'service-section';
            
            const title = document.createElement('h2');
            title.textContent = service.name;
            serviceSection.appendChild(title);

            const siteGrid = document.createElement('div');
            siteGrid.className = 'site-grid';

            testSites.forEach(site => {
                const siteItem = document.createElement('div');
                siteItem.className = 'site-item';
                
                const img = document.createElement('img');
                let domain = '';
                try {
                    const urlObj = new URL(site.url);
                    domain = urlObj.hostname.replace(/^www\./, '');
                } catch (e) {
                    // Fallback for potentially invalid URLs in testSites
                    domain = site.url.replace(/^https?:\/\//, '').split('/')[0].replace(/^www\./, '');
                    console.warn(`简易回退提取域名 for ${site.url}: ${domain}`);
                }

                const faviconUrl = service.getUrl(site.url, domain);
                img.src = faviconUrl;
                img.alt = ``; // 空 alt
                
                const siteNameSpan = document.createElement('span');
                siteNameSpan.className = 'site-name';
                siteNameSpan.textContent = site.name;
                
                const statusSpan = document.createElement('span');
                statusSpan.className = 'status';
                statusSpan.textContent = '加载中...';

                img.onload = function() {
                    statusSpan.textContent = '成功';
                    statusSpan.className = 'status ok';
                };
                img.onerror = function() {
                    statusSpan.textContent = '失败';
                    statusSpan.className = 'status error';
                    img.style.opacity = '0.2'; // 使失败的图标变淡，而不是完全隐藏
                    // console.warn(`加载失败 (${service.name}): ${faviconUrl}`);
                };
                
                siteItem.appendChild(img);
                siteItem.appendChild(siteNameSpan);
                siteItem.appendChild(statusSpan);
                siteGrid.appendChild(siteItem);
            });
            serviceSection.appendChild(siteGrid);
            resultsContainer.appendChild(serviceSection);
        });
    </script>
</body>
</html>